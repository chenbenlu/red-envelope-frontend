<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ç´…åŒ…å¤§æŒ‘æˆ° (ç‚«ç‚®æ¥µé€Ÿç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #app { width: 100%; max-width: 400px; height: 100vh; background-color: #1e1e1e; box-shadow: 0 0 20px rgba(0,0,0,0.8); position: relative; text-align: center; display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; padding: 20px; flex-direction: column; justify-content: center; }
        .active { display: flex; }
        
        h1 { color: #ff5252; text-shadow: 0 0 10px rgba(255, 82, 82, 0.5); }
        input { padding: 12px; font-size: 16px; width: 100%; margin-bottom: 15px; text-align: center; box-sizing: border-box; background: #333; border: 1px solid #555; color: #fff; border-radius: 8px; }
        button { padding: 12px 20px; font-size: 18px; background: linear-gradient(45deg, #ff5252, #fbc02d); color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-weight: bold; transition: transform 0.1s, box-shadow 0.1s; }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        
        .status-bar { padding: 10px; background: #2c2c2c; font-weight: bold; font-size: 14px; line-height: 1.6; border-bottom: 2px solid #444; }
        
        /* éŠæˆ²å€åŸŸåŸºç¤è¨­å®š */
        #game-area { position: relative; flex: 1; background-color: #2a2a2a; overflow: hidden; transition: background 0.3s, box-shadow 0.3s; }
        
        /* ğŸ”¥ ç‚«ç‚®å¤–æ›æ¨¡å¼ (Overdrive) */
        #game-area.overdrive {
            background-color: #0d001a;
            box-shadow: inset 0 0 50px #b000ff;
            border-top: 2px solid #00e5ff;
            border-bottom: 2px solid #00e5ff;
            animation: cyber-strobe 0.5s infinite alternate;
        }
        @keyframes cyber-strobe {
            0% { box-shadow: inset 0 0 30px #b000ff; border-color: #00e5ff; }
            100% { box-shadow: inset 0 0 80px #ff0055; border-color: #ff0055; }
        }

        /* ç´…åŒ…æœ¬é«”èˆ‡å‹•ç•« */
        .envelope { 
            position: absolute; width: 55px; height: 75px; 
            background: linear-gradient(135deg, #d32f2f, #ff1744); 
            border: 2px solid #ffd700;
            color: #ffd700; border-radius: 6px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 24px; font-weight: bold; cursor: pointer; user-select: none; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            animation: fall linear forwards, wiggle 0.4s infinite alternate; 
        }
        @keyframes fall { from { top: -100px; } to { top: 110%; } }
        @keyframes wiggle { from { transform: rotate(-15deg) scale(1); } to { transform: rotate(15deg) scale(1.1); } }
        
        /* é»æ“Šç¬é–“çš„ç¢è£‚/æ¶ˆå¤±ç‰¹æ•ˆ */
        .grabbed-effect { transform: scale(0.1) rotate(45deg); opacity: 0; transition: all 0.2s ease-out; pointer-events: none; }

        /* æµ®å‹•é‡‘é¡æ•¸å­— */
        .floating-amount {
            position: absolute; color: #00ffaa; font-size: 28px; font-weight: 900;
            text-shadow: 0 0 10px #00ffaa, 0 0 20px #005500; pointer-events: none;
            animation: floatUp 0.8s ease-out forwards; z-index: 50;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 1; }
            50% { transform: translate(-50%, -40px) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -80px) scale(1); opacity: 0; }
        }

        /* ç•«é¢éœ‡å‹• */
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #result-modal { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #00e5ff; padding: 20px; border-radius: 10px; z-index: 100; font-size: 28px; font-weight: bold; border: 2px solid #00e5ff; box-shadow: 0 0 20px #00e5ff; text-align: center;}
        
        table { border-collapse: collapse; width: 100%; margin-top: 15px; background: #222; font-size: 14px; }
        th, td { border: 1px solid #444; padding: 8px; text-align: center; }
        th { background-color: #333; color: #ff5252; }
        
        .raise-box { background: #333; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px dashed #fbc02d; box-shadow: 0 0 10px rgba(251, 192, 45, 0.2); }
        
        /* é–‹é—œæŒ‰éˆ•ç¾åŒ– */
        .toggle-label { cursor: pointer; color: #00e5ff; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; text-shadow: 0 0 5px #00e5ff; transition: color 0.3s; }
        .toggle-label:hover { color: #ff0055; text-shadow: 0 0 10px #ff0055; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: #ff0055; cursor: pointer; }

        #admin-panel { position: absolute; bottom: 10px; right: 10px; font-size: 12px; display: none; }
        #admin-panel button { background: #111; border: 1px solid #444; padding: 5px 10px; font-size: 12px; margin-left: 5px; color: #aaa; box-shadow: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-bet" class="screen active">
        <h1>ğŸ§§ è³½åšç´…åŒ…å¤§æˆ° ğŸ§§</h1>
        <p style="color: #aaa;">æ¯ 100 å…ƒ = 1 æ¬¡é§­å…¥æ©Ÿæœƒ</p>
        <input type="text" id="username" placeholder="è¼¸å…¥ä»£è™Ÿ (ä¾‹å¦‚: Neo)">
        <input type="number" id="bet-amount" placeholder="æ³¨å…¥è³‡é‡‘ (100çš„å€æ•¸)" step="100" min="100">
        <button id="btn-bet" onclick="submitBet()">ç¢ºèªé€£æ¥ç³»çµ±</button>
        <p id="bet-msg" style="color: #ff5252;"></p>
    </div>

    <div id="screen-wait" class="screen">
        <h1>é€£ç·šå°±ç·’...</h1>
        <p id="wait-status" style="font-weight: bold; color: #00e5ff; text-shadow: 0 0 5px #00e5ff;">ç‹€æ…‹: æƒæç¯€é»ä¸­...</p>
        
        <div class="raise-box">
            <h3 style="margin-top: 0; color: #fbc02d;">ğŸ”¥ è³‡æºä¸è¶³ï¼Ÿè¿½åŠ ç®—åŠ›ï¼</h3>
            <p>ç›®å‰ç¸½è³‡é‡‘: <span id="display-current-bet" style="color:#00ffaa; font-weight:bold; font-size:18px;">0</span></p>
            <p>ç´¯ç©é§­å…¥æ¬¡æ•¸: <span id="display-current-tickets" style="color:#00ffaa; font-weight:bold; font-size:18px;">0</span></p>
            <input type="number" id="raise-amount" placeholder="è¿½åŠ è³‡é‡‘ (100çš„å€æ•¸)" step="100" min="100">
            <button id="btn-raise" onclick="submitRaise()" style="width: 100%; background: linear-gradient(45deg, #fbc02d, #f57f17); color: #000;">è¿½åŠ ç®—åŠ›</button>
            <p id="raise-msg" style="color: #ff5252; margin-bottom: 0;"></p>
        </div>
    </div>

    <div id="screen-grab" class="screen" style="padding: 0;">
        <div class="status-bar">
            ä»£è™Ÿ: <span id="display-name" style="color:#fbc02d;"></span> | å‰©é¤˜æ¬¡æ•¸: <span id="display-tickets" style="font-size:18px; color:#00ffaa;">0</span><br>
            å·²å¥ªå–è³‡é‡‘: <span id="display-won" style="color: #ff5252; font-size: 22px; text-shadow: 0 0 5px #ff5252;">0</span>
            <hr style="margin: 8px 0; border-color: #444;">
            <label class="toggle-label">
                <input type="checkbox" id="auto-grab-toggle"> âš¡ å•Ÿå‹•æ¥µé€Ÿé§­å…¥å¤–æ› (AUTO-BOT)
            </label>
        </div>
        <div id="game-area"></div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h1 style="color: #00e5ff; text-shadow: 0 0 10px #00e5ff;">ğŸ† ä¼ºæœå™¨çµç®—å ±å‘Š ğŸ†</h1>
        <div style="background: #1a1a1a; border-radius: 8px; padding: 5px; text-align: left; overflow-x: auto; border: 1px solid #333;">
            <table>
                <thead>
                    <tr><th>æ’å</th><th>ä»£è™Ÿ</th><th>æŠ•å…¥</th><th>å¥ªå–</th><th>æ·¨åˆ©</th><th>ROI</th></tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <button style="margin-top: 20px; background: #333; color: #fff;" onclick="window.location.reload()">ä¸­æ–·é€£ç·š (é‡æ–°é–‹å§‹)</button>
    </div>

    <div id="result-modal"></div>

    <div id="admin-panel">
        <button onclick="adminSettle()">å¼·åˆ¶å¼•çˆ†</button>
        <button onclick="adminReset()">æ ¼å¼åŒ–ç³»çµ±</button>
    </div>
</div>

<script>
    // âš ï¸ æ›¿æ›æˆä½ çš„ Ngrok ç¶²å€
    const API_BASE = "https://untruckled-dalilah-twitchily.ngrok-free.dev"; 
    
    const headers = {
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true'
    };
    
    // æš—é–€
    if (new URLSearchParams(window.location.search).get('admin') === 'true') {
        document.getElementById('admin-panel').style.display = 'block';
    }
    
    let currentUser = "";
    let myTotalBet = 0;
    let myTickets = 0;
    let myTotalWon = 0;
    let dropTimer = null;
    let pollingInterval = null;
    let isGrabbing = false;
    let currentDropSpeed = 400; // é è¨­æ‰è½é–“éš”

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    // --- API: æŠ•æ³¨èˆ‡åŠ æ³¨ ---
    async function submitBet() {
        const user = document.getElementById('username').value.trim();
        const amount = parseInt(document.getElementById('bet-amount').value, 10);
        const msgEl = document.getElementById('bet-msg');

        if (!user || isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "åƒæ•¸éŒ¯èª¤ï¼éœ€ç‚º100çš„å€æ•¸"; return; }

        document.getElementById('btn-bet').disabled = true;
        msgEl.innerText = "æ­£åœ¨å»ºç«‹é€šé“...";

        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: user, amount: amount }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            currentUser = user; myTickets = data.tickets; myTotalBet = data.total_bet; myTotalWon = 0;
            document.getElementById('display-name').innerText = currentUser;
            updateWaitScreenInfo();
            switchScreen('screen-wait');
            startPolling(); 
        } catch (err) { msgEl.innerText = err.message; document.getElementById('btn-bet').disabled = false; }
    }

    async function submitRaise() {
        const amount = parseInt(document.getElementById('raise-amount').value, 10);
        const msgEl = document.getElementById('raise-msg');
        const btn = document.getElementById('btn-raise');

        if (isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "ç„¡æ•ˆçš„è³‡é‡‘"; return; }
        btn.disabled = true; msgEl.innerText = "è¿½åŠ ä¸­...";

        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets; myTotalBet = data.total_bet; updateWaitScreenInfo();
            document.getElementById('raise-amount').value = '';
            msgEl.innerText = "âœ… ç®—åŠ›å·²å‡ç´š";
            setTimeout(() => { msgEl.innerText = ""; }, 2000);
        } catch (err) { msgEl.innerText = err.message; } finally { btn.disabled = false; }
    }

    function updateWaitScreenInfo() {
        document.getElementById('display-current-bet').innerText = myTotalBet;
        document.getElementById('display-current-tickets').innerText = myTickets;
        updateStatusBar();
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                document.getElementById('wait-status').innerText = `ç¸½è³‡é‡‘æ± : ${data.total_pool} | ç‹€æ…‹: ${data.status}`;
                if (data.status === "GRABBING") {
                    clearInterval(pollingInterval);
                    startGame();
                }
            } catch (err) { console.error(err); }
        }, 1000);
    }

    // --- ğŸ® ç‚«ç‚®éŠæˆ²å¼•æ“ ---
    function startGame() {
        switchScreen('screen-grab');
        scheduleNextDrop();
    }

    // éè¿´å‘¼å«ä¾†æ§åˆ¶æ‰è½é€Ÿåº¦ (é…åˆå¤–æ›æ¨¡å¼åŠ é€Ÿ)
    function scheduleNextDrop() {
        if (myTickets <= 0) return;
        createEnvelope();
        dropTimer = setTimeout(scheduleNextDrop, currentDropSpeed);
    }

    // ç›£è½å¤–æ›é–‹é—œ
    document.getElementById('auto-grab-toggle').addEventListener('change', (e) => {
        const area = document.getElementById('game-area');
        if(e.target.checked) {
            area.classList.add('overdrive'); // å•Ÿå‹•éœ“è™¹èƒŒæ™¯
            currentDropSpeed = 80; // æ‰è½é€Ÿåº¦é£†å‡ 5 å€
            showResultText("âš¡ OVERDRIVE å•Ÿå‹• âš¡");
        } else {
            area.classList.remove('overdrive');
            currentDropSpeed = 400; // æ¢å¾©æ­£å¸¸
        }
    });

    function createEnvelope() {
        const area = document.getElementById('game-area');
        const env = document.createElement('div');
        env.className = 'envelope';
        env.innerText = 'ğŸ§§';
        
        env.style.left = (Math.random() * (area.clientWidth - 55)) + 'px';
        // å¤–æ›æ¨¡å¼ä¸‹ï¼Œä¸åƒ…æ‰è½é »ç¹ï¼Œæ‰è½é€Ÿåº¦(CSS animation)ä¹Ÿè®Šå¿«
        const isOverdrive = document.getElementById('auto-grab-toggle').checked;
        const duration = isOverdrive ? (Math.random() * 0.8 + 0.8) : (Math.random() * 1.5 + 1.5);
        env.style.animationDuration = duration + 's';

        env.onclick = () => grabEnvelope(env);
        area.appendChild(env);

        setTimeout(() => { if(env.parentElement) env.remove(); }, duration * 1000);
    }

    // --- ç•«é¢éœ‡å‹•èˆ‡æµ®å‹•æ–‡å­—ç‰¹æ•ˆ ---
    function triggerScreenShake() {
        const app = document.getElementById('app');
        app.classList.remove('shake');
        void app.offsetWidth; // è§¸ç™¼ reflow è®“å‹•ç•«å¯é‡è¤‡åŸ·è¡Œ
        app.classList.add('shake');
    }

    function spawnFloatingNumber(amount, x, y) {
        const area = document.getElementById('game-area');
        const floatText = document.createElement('div');
        floatText.className = 'floating-amount';
        floatText.innerText = `+ğŸ’°${amount}`;
        floatText.style.left = x;
        floatText.style.top = y;
        area.appendChild(floatText);
        setTimeout(() => floatText.remove(), 800);
    }

    async function grabEnvelope(envElement) {
        if (myTickets <= 0 || isGrabbing || envElement.classList.contains('grabbed')) return;
        
        // æ¨™è¨˜ä¸¦è§¸ç™¼ç¢è£‚ç‰¹æ•ˆ
        envElement.classList.add('grabbed');
        envElement.classList.add('grabbed-effect');
        
        // è¨˜éŒ„è¢«é»æ“Šæ™‚çš„ä½ç½®ï¼Œçµ¦æµ®å‹•æ•¸å­—ç”¨
        const rect = envElement.getBoundingClientRect();
        const areaRect = document.getElementById('game-area').getBoundingClientRect();
        const relativeX = (rect.left - areaRect.left + 27) + 'px'; // +27 è®“æ•¸å­—ç½®ä¸­
        const relativeY = (rect.top - areaRect.top) + 'px';

        isGrabbing = true;

        try {
            const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets_left;
            myTotalWon = data.total_won_so_far;
            updateStatusBar();
            
            // API å›å‚³æˆåŠŸï¼Œå™´å‡ºç‰¹æ•ˆèˆ‡æ•¸å­—
            triggerScreenShake();
            spawnFloatingNumber(data.won_amount, relativeX, relativeY);

            if (myTickets <= 0) endGame();

        } catch (err) {
            if(err.message === "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") endGame();
        } finally {
            isGrabbing = false;
        }
    }

    // --- ğŸ¤– çµ‚æ¥µè‡ªå‹•ä»£æ¶å¤–æ› (50ms æ¥µé€Ÿæƒæ) ---
    setInterval(() => {
        const autoToggle = document.getElementById('auto-grab-toggle');
        if (autoToggle && autoToggle.checked && myTickets > 0 && !isGrabbing) {
            // å°‹æ‰¾ç•«é¢ä¸Šé‚„æ²’è¢«é»æ“Šçš„ç´…åŒ…
            const targets = document.querySelectorAll('.envelope:not(.grabbed)');
            if (targets.length > 0) {
                targets[0].click(); // ç§’æ®ºç¬¬ä¸€å€‹ç›®æ¨™
            }
        }
    }, 50);

    // --- çµç®— ---
    function endGame() {
        clearTimeout(dropTimer);
        document.getElementById('game-area').innerHTML = '<h2 style="color: #00e5ff; margin-top: 80px; text-shadow: 0 0 10px #00e5ff;">æ¬¡æ•¸ç”¨ç›¡ï¼<br><br>ç­‰å¾…ç³»çµ±æœ€çµ‚çµç®—...</h2>';
        
        const waitInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                if (data.status === "FINISHED") {
                    clearInterval(waitInterval);
                    fetchLeaderboard();
                }
            } catch (err) { console.error(err); }
        }, 1500);
    }

    async function fetchLeaderboard() {
        switchScreen('screen-leaderboard');
        try {
            const res = await fetch(`${API_BASE}/leaderboard`, { headers: headers });
            const data = await res.json();
            
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            
            data.leaderboard.forEach((player, index) => {
                const isMe = player.user === currentUser ? 'background-color: rgba(255,215,0,0.2); font-weight: bold; border-left: 4px solid #ffd700;' : '';
                const color = player.profit >= 0 ? 'color: #ff5252;' : 'color: #00ffaa;';
                
                const tr = document.createElement('tr');
                tr.style = isMe;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.user}</td>
                    <td>${player.bet}</td>
                    <td>${player.won}</td>
                    <td style="${color}">${player.profit > 0 ? '+'+player.profit : player.profit}</td>
                    <td style="${color}">${player.roi}%</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (err) { alert("ç„¡æ³•å–å¾—æ’è¡Œæ¦œ: " + err.message); }
    }

    function updateStatusBar() {
        document.getElementById('display-tickets').innerText = myTickets;
        document.getElementById('display-won').innerText = myTotalWon;
    }

    function showResultText(text) {
        const modal = document.getElementById('result-modal');
        modal.innerText = text;
        modal.style.display = 'block';
        setTimeout(() => modal.style.display = 'none', 800);
    }

    // --- ç®¡ç†å“¡ API ---
    async function adminSettle() {
        const secret = prompt("ç³»çµ±æˆæ¬Šç¢¼ï¼š");
        if (!secret) return;
        try {
            const res = await fetch(`${API_BASE}/admin/settle`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) });
            if (!res.ok) throw new Error((await res.json()).detail);
        } catch (err) { alert(err.message); }
    }

    async function adminReset() {
        const secret = prompt("ç³»çµ±æˆæ¬Šç¢¼ï¼š");
        if (!secret || !confirm("è­¦å‘Šï¼šå³å°‡éŠ·æ¯€æ‰€æœ‰ç¯€é»è³‡æ–™ï¼Ÿ")) return;
        try {
            const res = await fetch(`${API_BASE}/admin/reset`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) });
            if (!res.ok) throw new Error((await res.json()).detail);
            window.location.reload();
        } catch (err) { alert(err.message); }
    }
</script>
</body>
</html>