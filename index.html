<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¶ç´…åŒ…å¤§æŒ‘æˆ° (éŒ¢åŒ…æ ¸èŠ¯ç‰ˆ)</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background-color: #121212; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: manipulation; }
        #app { width: 100%; max-width: 400px; height: 100vh; background-color: #1e1e1e; box-shadow: 0 0 20px rgba(0,0,0,0.8); position: relative; text-align: center; display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; padding: 20px; flex-direction: column; justify-content: center; }
        .active { display: flex; }
        
        h1 { color: #ff5252; text-shadow: 0 0 10px rgba(255, 82, 82, 0.5); font-size: 24px; }
        input[type="text"], input[type="number"] { padding: 12px; font-size: 16px; width: 100%; margin-bottom: 15px; text-align: center; box-sizing: border-box; background: #333; border: 1px solid #555; color: #fff; border-radius: 8px; }
        button { padding: 12px 20px; font-size: 16px; background: linear-gradient(45deg, #ff5252, #fbc02d); color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-weight: bold; transition: transform 0.1s; width: 100%;}
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        
        /* éŒ¢åŒ…é¢æ¿ */
        .wallet-panel { background: #002200; border: 1px solid #00ffaa; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,255,170,0.2); }
        .wallet-amount { font-size: 28px; color: #00ffaa; font-weight: bold; text-shadow: 0 0 5px #00ffaa; }

        .status-bar { padding: 10px 15px; background: #2c2c2c; font-weight: bold; border-bottom: 2px solid #444; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .status-won { font-size: 20px; color: #ff5252; text-shadow: 0 0 5px #ff5252; margin-bottom: 10px; }
        
        .controls-row { display: flex; justify-content: space-between; gap: 10px; }
        .compact-btn { flex: 1; padding: 8px 5px; font-size: 13px; border-radius: 6px; background: #444; color: #fff; border: 1px solid #555; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
        .compact-btn.active-toggle { background: #b000ff; border-color: #00e5ff; box-shadow: 0 0 10px #b000ff; color: #fff; }
        
        #game-area { position: relative; flex: 1; background-color: #2a2a2a; overflow: hidden; }
        #game-area.overdrive { background-color: #0d001a; box-shadow: inset 0 0 30px #b000ff; border-top: 2px solid #00e5ff; border-bottom: 2px solid #00e5ff; animation: cyber-strobe 0.5s infinite alternate; }
        @keyframes cyber-strobe { 0% { box-shadow: inset 0 0 20px #b000ff; } 100% { box-shadow: inset 0 0 50px #ff0055; } }

        .envelope { position: absolute; width: 45px; height: 60px; background: linear-gradient(135deg, #d32f2f, #ff1744); border: 2px solid #ffd700; color: #ffd700; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; cursor: pointer; user-select: none; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); animation: fall linear forwards, wiggle 0.4s infinite alternate; }
        @keyframes fall { from { top: -80px; } to { top: 110%; } }
        @keyframes wiggle { from { transform: rotate(-15deg) scale(1); } to { transform: rotate(15deg) scale(1.1); } }
        .grabbed-effect { transform: scale(0.1) rotate(45deg); opacity: 0; transition: all 0.2s ease-out; pointer-events: none; }
        
        .floating-amount { position: absolute; color: #00ffaa; font-size: 24px; font-weight: 900; text-shadow: 0 0 10px #00ffaa, 0 0 20px #005500; pointer-events: none; animation: floatUp 0.6s ease-out forwards; z-index: 50; }
        @keyframes floatUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 1; } 50% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1); opacity: 0; } }
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        table { border-collapse: collapse; width: 100%; margin-top: 15px; background: #222; font-size: 13px; }
        th, td { border: 1px solid #444; padding: 6px; text-align: center; }
        th { background-color: #333; color: #ff5252; }
        
        .raise-box { background: #333; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px dashed #fbc02d; }
        
        #admin-panel { position: absolute; bottom: 10px; right: 10px; font-size: 12px; display: none; }
        #admin-panel button { background: #111; border: 1px solid #444; padding: 5px 10px; font-size: 12px; margin-left: 5px; color: #aaa; width: auto; margin-bottom: 0;}
    </style>
</head>
<body>

<div id="app">
    <div id="screen-login" class="screen active">
        <h1>ğŸ”— é€£æ¥ç³»çµ±</h1>
        <p style="color: #aaa; font-size: 14px;">å»ºç«‹å¸³æˆ¶ä¸¦æ³¨å…¥ç¸½è³‡é‡‘</p>
        <input type="text" id="username" placeholder="è¼¸å…¥ä»£è™Ÿ (ä¾‹å¦‚: Neo)">
        <input type="number" id="init-funds" placeholder="è¨­å®šåˆå§‹è³‡é‡‘ç¸½é¡" min="100">
        <button id="btn-login" onclick="joinGame()">ç™»å…¥ / å»ºç«‹éŒ¢åŒ…</button>
        <p id="login-msg" style="color: #ff5252; font-size: 14px;"></p>
    </div>

    <div id="screen-bet" class="screen">
        <h1>ğŸ§§ è³½åšç´…åŒ…å¤§æˆ° ğŸ§§</h1>
        
        <div class="wallet-panel">
            <div style="font-size:14px; color:#aaa; margin-bottom:5px;">ä½ çš„å¯ç”¨ç¸½è³‡é‡‘</div>
            <div class="wallet-amount">$<span id="display-wallet">0</span></div>
        </div>

        <input type="number" id="bet-amount" placeholder="è¼¸å…¥æœ¬å±€æŠ•æ³¨é‡‘é¡ (100çš„å€æ•¸)" step="100" min="100">
        <button id="btn-bet" onclick="submitBet()">ç¢ºèªæŠ•å…¥æœ¬å±€</button>
        <p id="bet-msg" style="color: #ff5252; font-size: 14px;"></p>
    </div>

    <div id="screen-wait" class="screen">
        <h2 style="margin-top: 0;">é€£ç·šå°±ç·’...</h2>
        <p id="wait-status" style="font-weight: bold; color: #00e5ff;">ç‹€æ…‹: ç­‰å¾…ç®¡ç†å“¡é–‹å±€...</p>
        
        <div class="raise-box">
            <h4 style="margin-top: 0; color: #fbc02d;">ğŸ”¥ å‰©é¤˜è³‡é‡‘è¿½åŠ </h4>
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px;">
                <span>å·²æŠ•: <span id="display-current-bet" style="color:#00ffaa; font-weight:bold;">0</span></span>
                <span>æ¬Šé™: <span id="display-current-tickets" style="color:#00ffaa; font-weight:bold;">0</span> æŠ½</span>
            </div>
            <input type="number" id="raise-amount" placeholder="å¾éŒ¢åŒ…è¿½åŠ  (100å€æ•¸)" step="100" min="100">
            <button id="btn-raise" onclick="submitRaise()" style="background: linear-gradient(45deg, #fbc02d, #f57f17); color: #000;">ç¢ºèªè¿½åŠ </button>
            <p id="raise-msg" style="color: #ff5252; margin-bottom: 0; font-size: 13px;"></p>
        </div>
    </div>

    <div id="screen-grab" class="screen" style="padding: 0;">
        <div class="status-bar">
            <div class="status-row">
                <span>ä»£è™Ÿ: <span id="display-name" style="color:#fbc02d;"></span></span>
                <span>å‰©é¤˜: <span id="display-tickets" style="color:#00ffaa; font-size: 16px;">0</span></span>
            </div>
            <div class="status-won">
                æœ¬å±€å·²å¥ªå–: <span id="display-won">0</span>
            </div>
            <div class="controls-row">
                <div id="btn-auto" class="compact-btn" onclick="toggleAutoBot()">âš¡ è‡ªå‹•ä»£æ¶</div>
                <div id="btn-skip" class="compact-btn" onclick="skipGrabbing()" style="background: #550000; border-color: #ff5252;">â­ï¸ ç¬é–“è·³é</div>
            </div>
        </div>
        <div id="game-area"></div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h2 style="color: #00e5ff; margin-top: 0;">ğŸ† æœ¬å±€çµç®—å ±å‘Š ğŸ†</h2>
        <div style="background: #1a1a1a; border-radius: 8px; padding: 2px; text-align: left; overflow-x: auto; border: 1px solid #333;">
            <table>
                <thead>
                    <tr><th>#</th><th>ä»£è™Ÿ</th><th>è³‡ç”¢é¤˜é¡</th><th>æœ¬å±€æ·¨åˆ©</th><th>æœ¬å±€ROI</th></tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <p style="color: #aaa; font-size: 14px; margin-top: 20px;">ç­‰å¾…ç®¡ç†å“¡é–‹å•Ÿä¸‹ä¸€å±€...</p>
    </div>

    <div id="admin-panel">
        <button onclick="adminSettle()">å¼•çˆ†é–‹å±€</button>
        <button onclick="adminNextRound()" style="background: #004400; color: #00ffaa;">ä¸‹ä¸€å±€</button>
        <button onclick="adminReset()" style="background: #440000; color: #ff5252;">æ ¼å¼åŒ–</button>
    </div>
</div>

<script>
    // âš ï¸ æ›¿æ›æˆä½ çš„ Ngrok ç¶²å€
    const API_BASE = "https://untruckled-dalilah-twitchily.ngrok-free.dev"; 
    const headers = { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' };
    
    if (new URLSearchParams(window.location.search).get('admin') === 'true') {
        document.getElementById('admin-panel').style.display = 'block';
    }
    
    let currentUser = "";
    let myWallet = 0;
    let myTotalBet = 0;
    let myTickets = 0;
    let myTotalWon = 0;
    let dropTimer = null;
    let pollingInterval = null;
    let lbPollingInterval = null;
    let isGrabbing = false;
    let isAutoOn = false;
    let currentDropSpeed = 400;

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    // --- ç™»å…¥èˆ‡å»ºç«‹éŒ¢åŒ… ---
    async function joinGame() {
        const user = document.getElementById('username').value.trim();
        const funds = parseInt(document.getElementById('init-funds').value, 10);
        const msgEl = document.getElementById('login-msg');

        if (!user || isNaN(funds) || funds <= 0) { msgEl.innerText = "è³‡æ–™éŒ¯èª¤"; return; }
        
        document.getElementById('btn-login').disabled = true; msgEl.innerText = "é€£ç·šä¸­...";
        try {
            const res = await fetch(`${API_BASE}/join`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: user, initial_funds: funds }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            currentUser = user;
            myWallet = data.wallet;
            document.getElementById('display-name').innerText = currentUser;
            document.getElementById('display-wallet').innerText = myWallet;
            switchScreen('screen-bet');
        } catch (err) { msgEl.innerText = err.message; document.getElementById('btn-login').disabled = false; }
    }

    // --- æŠ•æ³¨ (å¾éŒ¢åŒ…æ‰£æ¬¾) ---
    async function submitBet() {
        const amount = parseInt(document.getElementById('bet-amount').value, 10);
        const msgEl = document.getElementById('bet-msg');
        if (isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "å¿…é ˆæ˜¯ 100 çš„å€æ•¸"; return; }

        document.getElementById('btn-bet').disabled = true; msgEl.innerText = "æ‰£æ¬¾ä¸­...";
        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets; myTotalBet = data.total_bet; myWallet = data.wallet; myTotalWon = 0;
            updateWaitScreenInfo(); 
            switchScreen('screen-wait'); 
            startPolling(); 
        } catch (err) { msgEl.innerText = err.message; document.getElementById('btn-bet').disabled = false; }
    }

    async function submitRaise() {
        const amount = parseInt(document.getElementById('raise-amount').value, 10);
        const msgEl = document.getElementById('raise-msg');
        if (isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "ç„¡æ•ˆçš„è³‡é‡‘"; return; }

        document.getElementById('btn-raise').disabled = true; msgEl.innerText = "è¿½åŠ ä¸­...";
        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets; myTotalBet = data.total_bet; myWallet = data.wallet;
            updateWaitScreenInfo();
            document.getElementById('raise-amount').value = ''; msgEl.innerText = "âœ… è¿½åŠ æˆåŠŸ";
            setTimeout(() => { msgEl.innerText = ""; }, 2000);
        } catch (err) { msgEl.innerText = err.message; } finally { document.getElementById('btn-raise').disabled = false; }
    }

    function updateWaitScreenInfo() {
        document.getElementById('display-current-bet').innerText = myTotalBet;
        document.getElementById('display-current-tickets').innerText = myTickets;
        document.getElementById('display-tickets').innerText = myTickets;
        document.getElementById('display-won').innerText = myTotalWon;
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                document.getElementById('wait-status').innerText = `ç¸½æ± : ${data.total_pool} | ç‹€æ…‹: ${data.status}`;
                if (data.status === "GRABBING") { clearInterval(pollingInterval); startGame(); }
            } catch (err) { console.error(err); }
        }, 1000);
    }

    function startGame() { switchScreen('screen-grab'); scheduleNextDrop(); }
    function scheduleNextDrop() { if (myTickets <= 0) return; createEnvelope(); dropTimer = setTimeout(scheduleNextDrop, currentDropSpeed); }

    function toggleAutoBot() {
        isAutoOn = !isAutoOn;
        const btn = document.getElementById('btn-auto');
        const area = document.getElementById('game-area');
        if(isAutoOn) {
            btn.classList.add('active-toggle'); btn.innerText = "âš¡ é—œé–‰å¤–æ›";
            area.classList.add('overdrive'); currentDropSpeed = 80;
        } else {
            btn.classList.remove('active-toggle'); btn.innerText = "âš¡ è‡ªå‹•ä»£æ¶";
            area.classList.remove('overdrive'); currentDropSpeed = 400;
        }
    }

    setInterval(() => {
        if (isAutoOn && myTickets > 0 && !isGrabbing) {
            const targets = document.querySelectorAll('.envelope:not(.grabbed)');
            if (targets.length > 0) targets[0].click();
        }
    }, 50);

    async function skipGrabbing() {
        if (myTickets <= 0 || isGrabbing) return;
        if (!confirm("ç¢ºå®šåœ¨èƒŒæ™¯è€—ç›¡æ‰€æœ‰ç®—åŠ›ï¼Ÿ")) return;
        clearTimeout(dropTimer); isAutoOn = false;
        document.getElementById('btn-auto').classList.remove('active-toggle');
        document.getElementById('game-area').classList.remove('overdrive');
        document.getElementById('game-area').innerHTML = '<h2 style="color: #fbc02d; margin-top: 80px;">â­ï¸ æš´åŠ›ç ´è§£ä¸­...</h2>';
        isGrabbing = true;
        try {
            while (myTickets > 0) {
                const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);
                myTickets = data.tickets_left; myTotalWon = data.total_won_so_far;
                document.getElementById('display-tickets').innerText = myTickets;
                document.getElementById('display-won').innerText = myTotalWon;
            }
        } catch (err) {} finally { isGrabbing = false; if (myTickets <= 0) endGame(); }
    }

    function createEnvelope() {
        const area = document.getElementById('game-area');
        const env = document.createElement('div'); env.className = 'envelope'; env.innerText = 'ğŸ§§';
        env.style.left = (Math.random() * (area.clientWidth - 45)) + 'px';
        const duration = isAutoOn ? (Math.random() * 0.8 + 0.8) : (Math.random() * 1.5 + 1.2);
        env.style.animationDuration = duration + 's';
        env.onclick = () => grabEnvelope(env); area.appendChild(env);
        setTimeout(() => { if(env.parentElement) env.remove(); }, duration * 1000);
    }

    async function grabEnvelope(envElement) {
        if (myTickets <= 0 || isGrabbing || envElement.classList.contains('grabbed')) return;
        envElement.classList.add('grabbed'); envElement.classList.add('grabbed-effect');
        isGrabbing = true;
        try {
            const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets_left; myTotalWon = data.total_won_so_far; myWallet = data.wallet;
            document.getElementById('display-tickets').innerText = myTickets;
            document.getElementById('display-won').innerText = myTotalWon;
            if (myTickets <= 0) endGame();
        } catch (err) { if(err.message === "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") endGame(); } finally { isGrabbing = false; }
    }

    function endGame() {
        clearTimeout(dropTimer);
        document.getElementById('game-area').innerHTML = '<h2 style="color: #00e5ff; margin-top: 80px;">é€£ç·šä¸­æ–·<br><br>ç­‰å¾…ç³»çµ±æœ€çµ‚çµç®—...</h2>';
        const waitInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                if (data.status === "FINISHED") { clearInterval(waitInterval); fetchLeaderboard(); }
            } catch (err) { console.error(err); }
        }, 1500);
    }

    async function fetchLeaderboard() {
        switchScreen('screen-leaderboard');
        try {
            const res = await fetch(`${API_BASE}/leaderboard`, { headers: headers });
            const data = await res.json();
            const tbody = document.getElementById('leaderboard-body'); tbody.innerHTML = '';
            
            data.leaderboard.forEach((player, index) => {
                const isMe = player.user === currentUser ? 'background-color: rgba(255,215,0,0.15); font-weight: bold;' : '';
                const color = player.profit >= 0 ? 'color: #ff5252;' : 'color: #00ffaa;';
                // æ’è¡Œæ¦œæ›´æ–°ï¼šåŠ å…¥äº†ã€Œè³‡ç”¢é¤˜é¡ (Wallet)ã€çš„é¡¯ç¤º
                const tr = document.createElement('tr'); tr.style = isMe;
                tr.innerHTML = `<td>${index + 1}</td><td>${player.user}</td><td style="color:#00ffaa;">$${player.wallet}</td><td style="${color}">${player.profit > 0 ? '+'+player.profit : player.profit}</td><td style="${color}">${player.roi}%</td>`;
                tbody.appendChild(tr);
            });
            startLeaderboardPolling(); // é–‹å§‹ç­‰å¾…ä¸‹ä¸€å±€
        } catch (err) { alert("ç„¡æ³•å–å¾—: " + err.message); }
    }

    // --- è¼ªè©¢ç­‰å¾…ç®¡ç†å“¡é–‹å•Ÿä¸‹ä¸€å±€ ---
    function startLeaderboardPolling() {
        lbPollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                // å¦‚æœç®¡ç†å“¡æŒ‰ä¸‹äº†ã€Œä¸‹ä¸€å±€ã€ï¼Œç‹€æ…‹æœƒè®Šå› OPEN
                if (data.status === "OPEN") {
                    clearInterval(lbPollingInterval);
                    // ä¸ç”¨é‡æ–°æ•´ç†ç¶²é ï¼ç›´æ¥æ›´æ–° UI å›åˆ°æŠ•æ³¨ç•«é¢ï¼Œä¸¦é¡¯ç¤ºæœ€æ–°çš„éŒ¢åŒ…é¤˜é¡
                    document.getElementById('display-wallet').innerText = myWallet;
                    document.getElementById('btn-bet').disabled = false;
                    document.getElementById('bet-msg').innerText = '';
                    switchScreen('screen-bet');
                }
            } catch (err) {}
        }, 1500);
    }

    // --- ç®¡ç†å“¡ API ---
    async function adminSettle() {
        const secret = prompt("å¯†ç¢¼ï¼š"); if (!secret) return;
        try { await fetch(`${API_BASE}/admin/settle`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) }); } catch (err) {}
    }
    async function adminNextRound() {
        const secret = prompt("å¯†ç¢¼ (é–‹å•Ÿä¸‹ä¸€å±€ï¼Œä¿ç•™éŒ¢åŒ…)ï¼š"); if (!secret) return;
        try { await fetch(`${API_BASE}/admin/next_round`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) }); } catch (err) {}
    }
    async function adminReset() {
        const secret = prompt("å¯†ç¢¼ (å®Œå…¨æ ¼å¼åŒ–)ï¼š"); if (!secret || !confirm("ç¢ºå®šæ®ºå…‰æ‰€æœ‰å¸³æˆ¶ï¼Ÿ")) return;
        try { await fetch(`${API_BASE}/admin/reset`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) }); window.location.reload(); } catch (err) {}
    }
</script>
</body>
</html>