<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¿æ˜¥æ¶ç´…åŒ…å¤§è³½ (Cyberpunk Edition)</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: manipulation; }
        #app { width: 100%; max-width: 400px; height: 100vh; background-color: #1e1e1e; box-shadow: 0 0 20px rgba(0,229,255,0.2); position: relative; text-align: center; display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; padding: 20px; flex-direction: column; justify-content: center; }
        .active { display: flex; }
        
        /* ========================================= */
        /* ã€æ–°å¢ã€‘å…¨æœå¤§æˆ¶å»£æ’­ç‰¹æ•ˆ (Toast) */
        /* ========================================= */
        #global-toast {
            position: absolute; 
            top: -80px; /* é è¨­éš±è—åœ¨ç•«é¢ä¸Šæ–¹ */
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(0,0,0,0.95); 
            color: #ffcc00;
            padding: 12px 25px; 
            border-radius: 30px; 
            font-weight: bold; 
            font-size: 15px;
            z-index: 1000; 
            border: 2px solid #ffd700;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.8), inset 0 0 10px rgba(255, 0, 85, 0.5);
            transition: top 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            white-space: nowrap; 
            text-shadow: 0 0 5px #ff5252; 
        }
        .toast-show { top: 30px !important; } /* è§¸ç™¼æ™‚æ‰ä¸‹ä¾† */

        h1 { color: #ff5252; text-shadow: 0 0 10px rgba(255, 82, 82, 0.8); font-size: 26px; font-weight: 900; letter-spacing: 2px; }
        input[type="text"], input[type="number"] { padding: 12px; font-size: 16px; width: 100%; margin-bottom: 15px; text-align: center; box-sizing: border-box; background: #333; border: 1px solid #555; color: #00e5ff; border-radius: 8px; font-weight: bold; transition: border 0.3s; }
        input:focus { border-color: #00e5ff; outline: none; box-shadow: 0 0 8px rgba(0,229,255,0.5); }
        input::placeholder { color: #888; font-weight: normal; }
        
        button { padding: 12px 20px; font-size: 16px; background: linear-gradient(45deg, #ff5252, #fbc02d); color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-weight: bold; transition: transform 0.1s; width: 100%;}
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        
        .wallet-card { background: #111; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,229,255,0.2); border: 1px solid #00e5ff; position: relative; overflow: hidden; }
        .wallet-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0,229,255,0.2), transparent); animation: scanline 3s infinite linear; }
        @keyframes scanline { 0% { left: -100%; } 100% { left: 200%; } }
        .wallet-balance { font-size: 36px; font-weight: bold; color: #00ffaa; text-shadow: 0 0 10px rgba(0,255,170,0.5); margin-top: 5px; font-family: monospace;}
        
        .dashboard-info { display: flex; justify-content: space-between; background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px; }
        .info-block { flex: 1; }
        .info-title { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .info-value { font-size: 20px; font-weight: bold; color: #00e5ff; font-family: monospace; }
        
        .nav-btn { background: #2a2a2a; border: 1px solid #555; padding: 15px; border-radius: 8px; font-size: 16px; color: #fff; margin-bottom: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;}
        .nav-btn:hover { border-color: #00e5ff; box-shadow: 0 0 10px rgba(0,229,255,0.2); }
        .nav-btn:active { background: #333; transform: scale(0.98); }
        .nav-btn-icon { font-size: 20px; color: #00e5ff; }
        
        .status-bar { padding: 10px 15px; background: #111; font-weight: bold; border-bottom: 1px solid #00e5ff; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .controls-row { display: flex; justify-content: space-between; gap: 10px; }
        
        .compact-btn { flex: 1; padding: 8px 5px; font-size: 14px; border-radius: 6px; background: #333; color: #fff; border: 1px solid #555; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; transition: 0.2s; font-weight: bold;}
        .compact-btn:active { transform: scale(0.95); }
        .compact-btn.active-toggle { background: #b000ff; color: #fff; border-color: #00e5ff; box-shadow: 0 0 15px #b000ff; text-shadow: 0 0 5px #fff;}
        
        #game-area { position: relative; flex: 1; background-color: #2a2a2a; overflow: hidden; transition: background 0.3s, box-shadow 0.3s; }
        #game-area.overdrive { background-color: #0d001a; box-shadow: inset 0 0 40px #b000ff; border-top: 1px solid #00e5ff; border-bottom: 1px solid #00e5ff; animation: cyber-strobe 0.5s infinite alternate; }
        @keyframes cyber-strobe { 0% { box-shadow: inset 0 0 20px #b000ff; } 100% { box-shadow: inset 0 0 60px #ff0055; } }

        .envelope { position: absolute; width: 45px; height: 60px; background: linear-gradient(135deg, #d32f2f, #ff1744); border: 2px solid #ffd700; color: #ffd700; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; cursor: pointer; user-select: none; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); animation: fall linear forwards, wiggle 0.4s infinite alternate; }
        @keyframes fall { from { top: -80px; } to { top: 110%; } }
        @keyframes wiggle { from { transform: rotate(-15deg) scale(1); } to { transform: rotate(15deg) scale(1.1); } }
        .grabbed-effect { transform: scale(0.1) rotate(45deg); opacity: 0; transition: all 0.2s ease-out; pointer-events: none; }
        
        .floating-amount { position: absolute; color: #00ffaa; font-size: 28px; font-weight: 900; text-shadow: 0 0 10px #00ffaa, 0 0 20px #005500; pointer-events: none; animation: floatUp 0.6s ease-out forwards; z-index: 50; font-family: monospace;}
        @keyframes floatUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 1; } 50% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1); opacity: 0; } }
        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        #result-modal { display: none; position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #00e5ff; padding: 10px 20px; border-radius: 10px; z-index: 100; font-size: 16px; font-weight: bold; border: 1px solid #00e5ff; text-align: center; white-space: nowrap; box-shadow: 0 0 15px rgba(0,229,255,0.5);}
        
        table { border-collapse: collapse; width: 100%; margin-top: 15px; background: #111; font-size: 13px; }
        th, td { border: 1px solid #444; padding: 6px; text-align: center; }
        th { background-color: #222; color: #ff5252; }
        
        .action-box { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .back-btn { background: #333; color: #aaa; border: 1px solid #555; }
        
        #admin-panel { position: absolute; bottom: 10px; right: 10px; font-size: 12px; display: none; z-index: 200;}
        #admin-panel button { width: auto; background: #111; border: 1px solid #555; padding: 5px 10px; font-size: 12px; margin-left: 5px; color: #aaa; margin-bottom: 0; box-shadow: none;}
        #admin-left { position: absolute; bottom: 10px; left: 10px; font-size: 12px; display: none; z-index: 200; }
        #admin-left button { width: auto; background: #111; border: 1px solid #00ffaa; padding: 5px 10px; font-size: 12px; color: #00ffaa; margin-bottom: 0; box-shadow: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="global-toast">ğŸ“¢ è²¡ç¥å»£æ’­æ¸¬è©¦</div>

    <div id="screen-login" class="screen active">
        <h1>ğŸ§§ è¿æ˜¥æ¶ç´…åŒ…å¤§è³½ ğŸ§§</h1>
        <p style="color: #00e5ff; font-size: 14px; font-weight: bold; text-shadow: 0 0 5px rgba(0,229,255,0.5);">æ–°å¹´ç™¼å¤§è²¡ï¼è«‹å…ˆç¶å®šæ‚¨çš„éŒ¢åŒ…</p>
        <input type="text" id="username" placeholder="è¼¸å…¥ç©å®¶æš±ç¨±">
        <button id="btn-login" onclick="login()" style="background: linear-gradient(45deg, #00e5ff, #0077ff); border: 1px solid #00e5ff; box-shadow: 0 0 10px rgba(0,229,255,0.3);">é€²å…¥å¤§å»³</button>
        <p id="login-msg" style="color: #ff5252; font-size: 14px; font-weight: bold;"></p>
    </div>

    <div id="screen-lobby" class="screen" style="justify-content: flex-start; padding-top: 30px;">
        <div class="wallet-card">
            <div style="font-size: 14px; color: #aaa; font-weight: bold;">ç©å®¶ä»£è™Ÿ: <span id="lobby-name" style="color:#00e5ff;"></span></div>
            <div style="margin-top: 5px; font-size: 14px; color: #ccc;">ç›®å‰éŒ¢åŒ…é¤˜é¡</div>
            <div class="wallet-balance">$ <span id="lobby-wallet">0</span></div>
        </div>

        <div class="dashboard-info">
            <div class="info-block" style="border-right: 1px solid #444;">
                <div class="info-title">æœ¬å±€å·²æŠ•å…¥ (å…ƒ)</div>
                <div class="info-value" id="lobby-bet" style="color: #fff;">0</div>
            </div>
            <div class="info-block" style="padding-left: 15px;">
                <div class="info-title">æŒæœ‰ç´…åŒ… (å€‹)</div>
                <div class="info-value" id="lobby-tickets" style="color:#ff5252; text-shadow: 0 0 5px rgba(255,82,82,0.5);">0</div>
            </div>
        </div>

        <p id="wait-status" style="font-weight: bold; color: #00ffaa; margin-bottom: 20px; font-size: 16px; font-family: monospace;">ç­‰å¾…ä¼ºæœå™¨é–‹å±€...</p>
        
        <div class="nav-btn" onclick="openScreen('screen-recharge')">
            <div>ğŸ’³ å‰å¾€å„²å€¼ä¸­å¿ƒ</div>
            <div class="nav-btn-icon">â”</div>
        </div>
        <div class="nav-btn" onclick="openScreen('screen-action')" style="border-color: #ff5252;">
            <div style="color: #ff5252;">ğŸ§§ è³¼è²·ç´…åŒ… / è´ŠåŠ©</div>
            <div class="nav-btn-icon" style="color: #ff5252;">â”</div>
        </div>
    </div>

    <div id="screen-recharge" class="screen">
        <h2 style="color: #00e5ff; text-shadow: 0 0 10px rgba(0,229,255,0.5);">ğŸ’³ å„²å€¼ä¸­å¿ƒ</h2>
        <p style="color: #aaa; font-size: 14px; margin-bottom: 20px;">å„²å€¼å¾Œå³å¯è³¼è²·ç´…åŒ…</p>
        <input type="number" id="input-recharge" placeholder="è¼¸å…¥å„²å€¼é‡‘é¡ (å…ƒ)" min="1">
        <button onclick="recharge()" style="background: linear-gradient(45deg, #00e5ff, #0077ff); border: 1px solid #00e5ff;">ç¢ºèªå„²å€¼</button>
        <button class="back-btn" onclick="openScreen('screen-lobby')">è¿”å›å¤§å»³</button>
        <p id="recharge-msg" style="color: #ff5252; font-size: 14px; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <div id="screen-action" class="screen">
        <h2 style="color: #ff5252; text-shadow: 0 0 10px rgba(255,82,82,0.5);">ğŸ§§ è³¼è²·èˆ‡è´ŠåŠ©</h2>
        <p style="color: #aaa; font-size: 14px; margin-bottom: 5px;">éŒ¢åŒ…é¤˜é¡: <span id="action-wallet-display" style="color: #00ffaa; font-weight:bold; font-family: monospace;">0</span></p>
        <p style="color: #777; font-size: 12px; margin-bottom: 20px;">1 å€‹ç´…åŒ… = 100 å…ƒ</p>
        
        <input type="number" id="input-action" placeholder="è¼¸å…¥è³¼è²·æ•¸é‡ (å€‹)" min="1" step="1">
        
        <div style="display: flex; gap: 10px; margin-top: 10px; margin-bottom: 10px;">
            <button onclick="bet()" style="flex: 1; font-size:14px;">ğŸ§§ è²·ç´…åŒ…</button>
            <button onclick="donate()" style="flex: 1; background: #222; color: #fff; border: 1px solid #00ffaa; font-size:14px; text-shadow: 0 0 5px #00ffaa;">ğŸ’¸ ç„¡å„Ÿè´ŠåŠ©çæ± </button>
        </div>
        <button class="back-btn" onclick="openScreen('screen-lobby')">è¿”å›å¤§å»³ç­‰å¾…</button>
        <p id="action-msg" style="color: #ff5252; font-size: 14px; margin-top: 15px; font-weight: bold;"></p>
    </div>

    <div id="screen-grab" class="screen" style="padding: 0;">
        <div class="status-bar">
            <div class="status-row">
                <span style="color: #aaa;">é¤˜é¡: <span id="grab-wallet" style="color:#00ffaa; font-family: monospace;">0</span></span>
                <span style="color: #aaa;">å‰©é¤˜: <span id="display-tickets" style="color:#ff5252; font-size: 18px; text-shadow: 0 0 5px #ff5252;">0</span> å€‹</span>
            </div>
            <div style="font-size: 20px; color: #fff; margin-bottom: 10px; text-align: left;">
                ç´¯ç©æ¶åˆ°: <span id="display-won" style="color: #00e5ff; text-shadow: 0 0 8px rgba(0,229,255,0.8); font-family: monospace; font-size: 24px;">0</span> å…ƒ
            </div>
            
            <div class="controls-row">
                <div id="btn-auto" class="compact-btn" onclick="toggleAutoBot()">âš¡ ç¥é€Ÿé€£é»</div>
                <div id="btn-skip" class="compact-btn" onclick="skipGrabbing()" style="background: #222; color: #ff5252; border-color: #550000;">â­ï¸ ç¬é–“çµç®—</div>
            </div>
        </div>
        <div id="game-area"></div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h2 style="color: #00e5ff; text-shadow: 0 0 10px rgba(0,229,255,0.5); margin-top: 0;">ğŸ† è²¡ç¥çˆºæ’è¡Œæ¦œ ğŸ†</h2>
        <div style="background: #111; border-radius: 8px; padding: 2px; text-align: left; overflow-x: auto; border: 1px solid #00e5ff;">
            <table>
                <thead>
                    <tr><th>åæ¬¡</th><th>ç©å®¶</th><th>æŠ•å…¥</th><th>æ¶åˆ°</th><th>æ·¨è³º</th><th>å ±é…¬ç‡</th></tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <button id="btn-next-round" style="margin-top: 20px; background: #222; color: #fff; border: 1px solid #ff5252;" onclick="prepareNextRound()">å‰å¾€è³¼è²·ç´…åŒ…</button>
    </div>

    <div id="result-modal"></div>

    <div id="admin-panel">
        <button onclick="adminSettle()" style="color: #fbc02d; border-color: #fbc02d;">å¼•çˆ†(ç™¼ç´…åŒ…)</button>
        <button onclick="adminHardReset()" style="color: #ff5252; border-color: #ff5252;">âš ï¸ ç³»çµ±é‡ç½®</button>
    </div>

    <div id="admin-left">
        <button onclick="adminReset()" style="color: #00ffaa; border-color: #00ffaa;">â†º é‡ç½®æœ¬å±€(é€€æ¬¾)</button>
    </div>
</div>

<script>
    // âš ï¸ éƒ¨ç½²å‰ï¼Œè«‹æ›¿æ›ç‚ºä½ çš„ Ngrok ç¶²å€
    const API_BASE = "https://untruckled-dalilah-twitchily.ngrok-free.dev"; 
    const headers = { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' };
    
    if (new URLSearchParams(window.location.search).get('admin') === 'true') {
        document.getElementById('admin-panel').style.display = 'block';
        document.getElementById('admin-left').style.display = 'block'; 
    }
    
    let currentUser = "";
    let myWallet = 0;
    let myTotalBet = 0;
    let myTickets = 0;
    let myTotalWon = 0;
    
    let dropTimer = null;
    let pollingInterval = null;
    let returnTimer = null; 
    let isGrabbing = false;
    let isAutoOn = false;
    let currentDropSpeed = 400;

    // ã€æ–°å¢ã€‘è¨˜éŒ„æœ€å¾Œçœ‹éçš„å»£æ’­æ™‚é–“æˆ³ï¼Œé¿å…é‡è¤‡å½ˆå‡º
    let lastSeenDonationTs = 0;

    function openScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        document.getElementById('recharge-msg').innerText = '';
        document.getElementById('action-msg').innerText = '';
        if(screenId === 'screen-action') {
            document.getElementById('action-wallet-display').innerText = myWallet;
        }
    }

    function showMsg(elId, text, color="#ff5252") {
        const el = document.getElementById(elId);
        el.innerText = text; el.style.color = color;
        setTimeout(() => el.innerText = "", 3000);
    }

    // ã€æ–°å¢ã€‘è§¸ç™¼å…¨æœå¤§æˆ¶å»£æ’­
    function triggerGlobalToast(user, amount) {
        const toast = document.getElementById('global-toast');
        toast.innerHTML = `ğŸ“¢ è²¡ç¥é™è‡¨ï¼š<span style="color:#fff;">[${user}]</span> éœ¸æ°£è´ŠåŠ©äº† <span style="color:#00ffaa;">$${amount}</span>ï¼`;
        toast.classList.add('toast-show');
        
        // 3 ç§’å¾Œè‡ªå‹•æ”¶å›
        setTimeout(() => {
            toast.classList.remove('toast-show');
        }, 3000);
    }

    function updateUI() {
        document.getElementById('lobby-wallet').innerText = myWallet;
        document.getElementById('action-wallet-display').innerText = myWallet;
        document.getElementById('grab-wallet').innerText = myWallet;
        document.getElementById('lobby-bet').innerText = myTotalBet;
        document.getElementById('lobby-tickets').innerText = myTickets;
        document.getElementById('display-tickets').innerText = myTickets;
        document.getElementById('display-won').innerText = myTotalWon;
    }

    async function login() {
        const user = document.getElementById('username').value.trim();
        if (!user) return showMsg('login-msg', "è«‹è¼¸å…¥æš±ç¨±ï¼");
        document.getElementById('btn-login').disabled = true;
        try {
            const res = await fetch(`${API_BASE}/login`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: user }) });
            const data = await res.json();
            currentUser = user; myWallet = data.wallet; 
            myTotalBet = 0; myTickets = 0; myTotalWon = 0; 
            
            document.getElementById('lobby-name').innerText = currentUser;
            updateUI(); openScreen('screen-lobby'); startPolling();
        } catch(err) { showMsg('login-msg', "ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨"); }
        finally { document.getElementById('btn-login').disabled = false; }
    }

    async function recharge() {
        const amount = parseInt(document.getElementById('input-recharge').value, 10);
        if (isNaN(amount) || amount <= 0) return showMsg('recharge-msg', "è«‹è¼¸å…¥æ­£ç¢ºçš„é‡‘é¡");
        try {
            const res = await fetch(`${API_BASE}/recharge`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if(!res.ok) throw new Error(data.detail);
            
            myWallet = data.wallet; updateUI(); 
            document.getElementById('input-recharge').value = '';
            
            openScreen('screen-lobby'); showResultText(`ğŸ’° æˆåŠŸå„²å€¼ $${amount} å…ƒ`);
        } catch(err) { showMsg('recharge-msg', err.message); }
    }

    async function bet() {
        const qty = parseInt(document.getElementById('input-action').value, 10);
        if (isNaN(qty) || qty <= 0) return showMsg('action-msg', "è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡");
        const amount = qty * 100; 

        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if(!res.ok) throw new Error(data.detail);
            
            myWallet = data.wallet; myTickets = data.tickets; myTotalBet = data.total_bet; updateUI();
            document.getElementById('input-action').value = ''; 
            
            openScreen('screen-lobby'); showResultText(`ğŸ§§ æˆåŠŸè³¼è²· ${qty} å€‹ç´…åŒ…`);
        } catch(err) { showMsg('action-msg', err.message); }
    }

    async function donate() {
        const qty = parseInt(document.getElementById('input-action').value, 10);
        if (isNaN(qty) || qty <= 0) return showMsg('action-msg', "è«‹è¼¸å…¥æ­£ç¢ºæ•¸é‡");
        const amount = qty * 100; 

        try {
            const res = await fetch(`${API_BASE}/donate`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if(!res.ok) throw new Error(data.detail);
            
            myWallet = data.wallet; myTotalBet = data.total_bet; updateUI();
            document.getElementById('input-action').value = ''; 
            openScreen('screen-lobby'); 
            
            // è‡ªå·±ææ¬¾ä¹Ÿæœƒæ”¶åˆ°å…¨æœå»£æ’­ï¼Œé€™è£¡ä¸ç”¨é¡¯ç¤ºå–®æ©Ÿ Toast
        } catch(err) { showMsg('action-msg', err.message); }
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                document.getElementById('wait-status').innerText = `ç¸½çé‡‘æ± : $${data.total_pool} | ç‹€æ…‹: ${data.status === 'OPEN' ? 'ç­‰å¾…é–‹å±€' : data.status}`;
                
                // ã€ä¿®æ”¹ã€‘æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„è´ŠåŠ©å»£æ’­
                if (data.last_donation && data.last_donation.ts > lastSeenDonationTs) {
                    // ç¬¬ä¸€æ¬¡ç™»å…¥æ™‚ä¸è¦è§¸ç™¼ä»¥å‰çš„èˆŠå»£æ’­
                    if (lastSeenDonationTs !== 0) {
                        triggerGlobalToast(data.last_donation.user, data.last_donation.amount);
                    }
                    lastSeenDonationTs = data.last_donation.ts; // æ›´æ–°æœ€æ–°æ™‚é–“æˆ³
                }

                if (data.status === "GRABBING") { clearInterval(pollingInterval); startGame(); }
            } catch (err) { console.error(err); }
        }, 1000);
    }

    function startGame() { 
        isAutoOn = false;
        currentDropSpeed = 400;
        const btnAuto = document.getElementById('btn-auto');
        btnAuto.classList.remove('active-toggle');
        btnAuto.innerText = "âš¡ ç¥é€Ÿé€£é»";
        
        const gameArea = document.getElementById('game-area');
        gameArea.classList.remove('overdrive');
        gameArea.innerHTML = ''; 
        
        openScreen('screen-grab'); 
        
        if (myTickets <= 0) {
            gameArea.innerHTML = '<h2 style="color: #ffcc00; margin-top: 80px; text-shadow: 0 0 10px rgba(255,204,0,0.8);">æ‚¨æœ¬å±€æœªåƒèˆ‡æ¶å¥ª<br><br><span style="font-size:16px; color:#aaa; text-shadow:none;">è§€æˆ°æ¨¡å¼ï¼šç­‰å¾…å…¶ä»–ç©å®¶æ¶å®Œ...</span></h2>';
            const waitInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE}/status`, { headers: headers });
                    const data = await res.json();
                    if (data.status === "FINISHED") { clearInterval(waitInterval); fetchLeaderboard(); }
                } catch (err) { console.error(err); }
            }, 1500);
            return;
        }

        scheduleNextDrop(); 
    }

    function scheduleNextDrop() {
        if (myTickets <= 0) return;
        createEnvelope(); dropTimer = setTimeout(scheduleNextDrop, currentDropSpeed);
    }

    function toggleAutoBot() {
        isAutoOn = !isAutoOn;
        const btn = document.getElementById('btn-auto');
        const area = document.getElementById('game-area');
        if(isAutoOn) {
            btn.classList.add('active-toggle'); btn.innerText = "âš¡ é—œé–‰ç¥é€Ÿ";
            area.classList.add('overdrive'); currentDropSpeed = 80; showResultText("ç¥é€Ÿé§­å…¥æ¨¡å¼ï¼");
        } else {
            btn.classList.remove('active-toggle'); btn.innerText = "âš¡ ç¥é€Ÿé€£é»";
            area.classList.remove('overdrive'); currentDropSpeed = 400;
        }
    }

    setInterval(() => {
        if (isAutoOn && myTickets > 0 && !isGrabbing) {
            const targets = document.querySelectorAll('.envelope:not(.grabbed)');
            if (targets.length > 0) targets[0].click();
        }
    }, 50);

    async function skipGrabbing() {
        if (myTickets <= 0 || isGrabbing) return;
        if (!confirm("ç¢ºå®šè¦ç¬é–“æ¶å®Œæ‰‹ä¸Šæ‰€æœ‰ç´…åŒ…å—ï¼Ÿ")) return;
        
        clearTimeout(dropTimer); 
        isAutoOn = false;
        document.getElementById('btn-auto').classList.remove('active-toggle');
        document.getElementById('btn-auto').innerText = "âš¡ ç¥é€Ÿé€£é»";
        
        const gameArea = document.getElementById('game-area');
        gameArea.classList.remove('overdrive');
        gameArea.innerHTML = '<h2 style="color:#00e5ff; margin-top:80px; text-shadow: 0 0 10px rgba(0,229,255,0.8);">è³‡æ–™çµç®—ä¸­...</h2>';
        
        isGrabbing = true;
        try {
            while (myTickets > 0) {
                const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);
                myTickets = data.tickets_left; myTotalWon = data.total_won_so_far; myWallet = data.wallet; updateUI();
            }
        } catch (err) { if(err.message !== "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") console.error(err); } 
        finally { isGrabbing = false; if (myTickets <= 0) endGame(); }
    }

    function createEnvelope() {
        const area = document.getElementById('game-area');
        const env = document.createElement('div');
        env.className = 'envelope'; env.innerText = 'ğŸ§§';
        env.style.left = (Math.random() * (area.clientWidth - 45)) + 'px';
        const duration = isAutoOn ? (Math.random() * 0.8 + 0.8) : (Math.random() * 1.5 + 1.2);
        env.style.animationDuration = duration + 's';
        env.onclick = () => grabEnvelope(env);
        area.appendChild(env);
        setTimeout(() => { if(env.parentElement) env.remove(); }, duration * 1000);
    }

    function triggerScreenShake() {
        const app = document.getElementById('app');
        app.classList.remove('shake'); void app.offsetWidth; app.classList.add('shake');
    }

    function spawnFloatingNumber(amount, x, y) {
        const area = document.getElementById('game-area');
        const floatText = document.createElement('div');
        floatText.className = 'floating-amount'; floatText.innerText = `+$${amount}`;
        floatText.style.left = x; floatText.style.top = y;
        area.appendChild(floatText); setTimeout(() => floatText.remove(), 600);
    }

    async function grabEnvelope(envElement) {
        if (myTickets <= 0 || isGrabbing || envElement.classList.contains('grabbed')) return;
        envElement.classList.add('grabbed'); envElement.classList.add('grabbed-effect');
        
        const rect = envElement.getBoundingClientRect();
        const areaRect = document.getElementById('game-area').getBoundingClientRect();
        const relativeX = (rect.left - areaRect.left + 22) + 'px'; 
        const relativeY = (rect.top - areaRect.top) + 'px';

        isGrabbing = true;
        try {
            const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets_left; myTotalWon = data.total_won_so_far; myWallet = data.wallet; updateUI();
            triggerScreenShake(); spawnFloatingNumber(data.won_amount, relativeX, relativeY);
            if (myTickets <= 0) endGame();
        } catch (err) { if(err.message === "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") endGame(); } 
        finally { isGrabbing = false; }
    }

    function endGame() {
        clearTimeout(dropTimer);
        document.getElementById('game-area').innerHTML = '<h2 style="color: #ff5252; margin-top: 80px; text-shadow: 0 0 10px rgba(255,82,82,0.8);">å·²å…¨æ•¸æ¶å®Œï¼<br><br><span style="font-size:16px; color:#aaa; text-shadow:none;">ç­‰å¾…ä¼ºæœå™¨å…¬ä½ˆæ¦œå–®...</span></h2>';
        const waitInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                if (data.status === "FINISHED") { clearInterval(waitInterval); fetchLeaderboard(); }
            } catch (err) { console.error(err); }
        }, 1500);
    }

    async function fetchLeaderboard() {
        openScreen('screen-leaderboard');
        try {
            const res = await fetch(`${API_BASE}/leaderboard`, { headers: headers });
            const data = await res.json();
            const tbody = document.getElementById('leaderboard-body'); tbody.innerHTML = '';
            
            data.leaderboard.forEach((player, index) => {
                const isMe = player.user === currentUser ? 'background-color: rgba(0,229,255,0.2); font-weight: bold;' : '';
                const color = player.profit >= 0 ? 'color: #ff5252;' : 'color: #00ffaa;';
                const sign = player.profit > 0 ? '+' : '';
                const tr = document.createElement('tr'); tr.style = isMe;
                tr.innerHTML = `<td>${index + 1}</td><td>${player.user}</td><td>${player.bet}</td><td>${player.won}</td><td style="${color}">${sign}${player.profit}</td><td style="${color}">${player.roi}%</td>`;
                tbody.appendChild(tr);
            });

            let cd = 15;
            const btn = document.getElementById('btn-next-round');
            btn.innerText = `å‰å¾€è³¼è²·ç´…åŒ… (${cd}s)`;
            
            if(returnTimer) clearInterval(returnTimer);
            returnTimer = setInterval(() => {
                cd--;
                btn.innerText = `å‰å¾€è³¼è²·ç´…åŒ… (${cd}s)`;
                if (cd <= 0) {
                    clearInterval(returnTimer);
                    prepareNextRound();
                }
            }, 1000);

        } catch (err) { showResultText("ç„¡æ³•å–å¾—æ’è¡Œæ¦œ"); }
    }

    function prepareNextRound() {
        if(returnTimer) clearInterval(returnTimer);
        myTotalBet = 0; myTickets = 0; myTotalWon = 0; updateUI();
        
        openScreen('screen-action'); 
        startPolling(); 
    }

    function showResultText(text) { 
        const modal = document.getElementById('result-modal'); 
        modal.innerText = text; modal.style.display = 'block'; 
        setTimeout(() => modal.style.display = 'none', 1500); 
    }

    async function adminSettle() {
        const secret = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š"); if (!secret) return;
        try { 
            const res = await fetch(`${API_BASE}/admin/settle`, { method: 'POST', headers: headers, body: JSON.stringify({ secret }) }); 
            if(!res.ok) throw new Error((await res.json()).detail);
        } catch(e){ alert(e.message); }
    }
    async function adminReset() {
        const secret = prompt("ã€é‡ç½®å–®å±€ã€‘è«‹è¼¸å…¥å¯†ç¢¼ï¼š"); if (!secret) return;
        if (!confirm("ç¢ºå®šè¦é‡ç½®æœ¬å±€ä¸¦ã€é€€é‚„ã€‘æ‰€æœ‰ç©å®¶çš„ä¸‹æ³¨å—ï¼Ÿ")) return;
        try { 
            await fetch(`${API_BASE}/admin/reset`, { method: 'POST', headers: headers, body: JSON.stringify({ secret }) }); 
            alert("æœ¬å±€å·²é‡ç½®ï¼Œè³‡é‡‘å·²é€€é‚„ã€‚"); window.location.reload(); 
        } catch(e) { alert(e.message); }
    }
    async function adminHardReset() {
        const secret = prompt("ã€æœ€é«˜æ¬Šé™ã€‘è«‹è¼¸å…¥å¯†ç¢¼ï¼š"); if (!secret) return;
        if (!confirm("!!! è­¦å‘Š !!!\nç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç©å®¶çš„éŒ¢åŒ…é¤˜é¡èˆ‡è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) return;
        try { 
            await fetch(`${API_BASE}/admin/hard_reset`, { method: 'POST', headers: headers, body: JSON.stringify({ secret }) }); 
            alert("è³‡æ–™åº«å·²æ¸…ç©ºï¼Œå°‡é‡æ–°è¼‰å…¥ã€‚"); window.location.reload(); 
        } catch(e) { alert(e.message); }
    }
</script>
</body>
</html>