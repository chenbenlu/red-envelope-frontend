<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¶ç´…åŒ…å¤§æŒ‘æˆ°</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: manipulation; }
        #app { width: 100%; max-width: 400px; height: 100vh; background-color: #1e1e1e; box-shadow: 0 0 20px rgba(0,0,0,0.8); position: relative; text-align: center; display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; padding: 20px; flex-direction: column; justify-content: center; }
        .active { display: flex; }
        
        h1 { color: #ff5252; text-shadow: 0 0 10px rgba(255, 82, 82, 0.5); font-size: 24px; }
        input[type="text"], input[type="number"] { padding: 12px; font-size: 16px; width: 100%; margin-bottom: 15px; text-align: center; box-sizing: border-box; background: #333; border: 1px solid #555; color: #fff; border-radius: 8px; }
        button { padding: 12px 20px; font-size: 16px; background: linear-gradient(45deg, #ff5252, #fbc02d); color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }
        
        /* æ‰‹æ©Ÿç‰ˆç‹€æ…‹åˆ—æœ€ä½³åŒ– */
        .status-bar { padding: 10px 15px; background: #2c2c2c; font-weight: bold; border-bottom: 2px solid #444; }
        .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
        .status-won { font-size: 20px; color: #ff5252; text-shadow: 0 0 5px #ff5252; margin-bottom: 10px; }
        
        /* å°å·§å‹æ§åˆ¶é¢æ¿ */
        .controls-row { display: flex; justify-content: space-between; gap: 10px; }
        .compact-btn { flex: 1; padding: 8px 5px; font-size: 13px; border-radius: 6px; background: #444; color: #fff; border: 1px solid #555; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
        .compact-btn.active-toggle { background: #b000ff; border-color: #00e5ff; box-shadow: 0 0 10px #b000ff; color: #fff; }
        
        /* éŠæˆ²å€åŸŸ */
        #game-area { position: relative; flex: 1; background-color: #2a2a2a; overflow: hidden; transition: background 0.3s, box-shadow 0.3s; }
        #game-area.overdrive { background-color: #0d001a; box-shadow: inset 0 0 30px #b000ff; border-top: 2px solid #00e5ff; border-bottom: 2px solid #00e5ff; animation: cyber-strobe 0.5s infinite alternate; }
        @keyframes cyber-strobe { 0% { box-shadow: inset 0 0 20px #b000ff; } 100% { box-shadow: inset 0 0 50px #ff0055; } }

        /* ç´…åŒ…èˆ‡ç‰¹æ•ˆ */
        .envelope { position: absolute; width: 45px; height: 60px; background: linear-gradient(135deg, #d32f2f, #ff1744); border: 2px solid #ffd700; color: #ffd700; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; cursor: pointer; user-select: none; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); animation: fall linear forwards, wiggle 0.4s infinite alternate; }
        @keyframes fall { from { top: -80px; } to { top: 110%; } }
        @keyframes wiggle { from { transform: rotate(-15deg) scale(1); } to { transform: rotate(15deg) scale(1.1); } }
        .grabbed-effect { transform: scale(0.1) rotate(45deg); opacity: 0; transition: all 0.2s ease-out; pointer-events: none; }
        
        .floating-amount { position: absolute; color: #00ffaa; font-size: 24px; font-weight: 900; text-shadow: 0 0 10px #00ffaa, 0 0 20px #005500; pointer-events: none; animation: floatUp 0.6s ease-out forwards; z-index: 50; }
        @keyframes floatUp { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 1; } 50% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1); opacity: 0; } }

        .shake { animation: shake 0.2s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        #result-modal { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #00e5ff; padding: 15px 30px; border-radius: 10px; z-index: 100; font-size: 24px; font-weight: bold; border: 2px solid #00e5ff; box-shadow: 0 0 20px #00e5ff; text-align: center; white-space: nowrap;}
        
        table { border-collapse: collapse; width: 100%; margin-top: 15px; background: #222; font-size: 13px; }
        th, td { border: 1px solid #444; padding: 6px; text-align: center; }
        th { background-color: #333; color: #ff5252; }
        
        .raise-box { background: #333; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px dashed #fbc02d; box-shadow: 0 0 10px rgba(251, 192, 45, 0.2); }
        
        #admin-panel { position: absolute; bottom: 10px; right: 10px; font-size: 12px; display: none; }
        #admin-panel button { background: #111; border: 1px solid #444; padding: 5px 10px; font-size: 12px; margin-left: 5px; color: #aaa; box-shadow: none; margin-bottom: 0;}
    </style>
</head>
<body>

<div id="app">
    <div id="screen-bet" class="screen active">
        <h1>ğŸ§§ è³½åšç´…åŒ…å¤§æˆ° ğŸ§§</h1>
        <p style="color: #aaa; font-size: 14px;">100 å…ƒ = 1 æ¬¡é§­å…¥æ¬Šé™</p>
        <input type="text" id="username" placeholder="è¼¸å…¥ä»£è™Ÿ (ä¾‹å¦‚: Neo)">
        <input type="number" id="bet-amount" placeholder="æ³¨å…¥è³‡é‡‘ (100çš„å€æ•¸)" step="100" min="100">
        <button id="btn-bet" onclick="submitBet()">ç¢ºèªé€£æ¥ç³»çµ±</button>
        <p id="bet-msg" style="color: #ff5252; font-size: 14px;"></p>
    </div>

    <div id="screen-wait" class="screen">
        <h2 style="margin-top: 0;">é€£ç·šå°±ç·’...</h2>
        <p id="wait-status" style="font-weight: bold; color: #00e5ff; text-shadow: 0 0 5px #00e5ff;">ç‹€æ…‹: æƒæç¯€é»ä¸­...</p>
        
        <div class="raise-box">
            <h4 style="margin-top: 0; color: #fbc02d;">ğŸ”¥ è¿½åŠ ç®—åŠ›</h4>
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px;">
                <span>ç¸½è³‡é‡‘: <span id="display-current-bet" style="color:#00ffaa; font-weight:bold;">0</span></span>
                <span>æ¬Šé™: <span id="display-current-tickets" style="color:#00ffaa; font-weight:bold;">0</span> æŠ½</span>
            </div>
            <input type="number" id="raise-amount" placeholder="è¿½åŠ è³‡é‡‘ (100å€æ•¸)" step="100" min="100">
            <button id="btn-raise" onclick="submitRaise()" style="width: 100%; background: linear-gradient(45deg, #fbc02d, #f57f17); color: #000; padding: 10px;">ç¢ºèªè¿½åŠ </button>
            <p id="raise-msg" style="color: #ff5252; margin-bottom: 0; font-size: 13px;"></p>
        </div>
    </div>

    <div id="screen-grab" class="screen" style="padding: 0;">
        <div class="status-bar">
            <div class="status-row">
                <span>ä»£è™Ÿ: <span id="display-name" style="color:#fbc02d;"></span></span>
                <span>å‰©é¤˜: <span id="display-tickets" style="color:#00ffaa; font-size: 16px;">0</span></span>
            </div>
            <div class="status-won">
                å·²å¥ªå–: <span id="display-won">0</span>
            </div>
            
            <div class="controls-row">
                <div id="btn-auto" class="compact-btn" onclick="toggleAutoBot()">âš¡ è‡ªå‹•ä»£æ¶</div>
                <div id="btn-skip" class="compact-btn" onclick="skipGrabbing()" style="background: #550000; border-color: #ff5252;">â­ï¸ ç¬é–“è·³é</div>
            </div>
        </div>
        <div id="game-area"></div>
    </div>

    <div id="screen-leaderboard" class="screen">
        <h2 style="color: #00e5ff; text-shadow: 0 0 10px #00e5ff; margin-top: 0;">ğŸ† çµç®—å ±å‘Š ğŸ†</h2>
        <div style="background: #1a1a1a; border-radius: 8px; padding: 2px; text-align: left; overflow-x: auto; border: 1px solid #333;">
            <table>
                <thead>
                    <tr><th>#</th><th>ä»£è™Ÿ</th><th>æŠ•å…¥</th><th>å¥ªå–</th><th>æ·¨åˆ©</th><th>ROI</th></tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <button style="margin-top: 20px; background: #333; color: #fff;" onclick="window.location.reload()">ä¸­æ–·é€£ç·š (é‡æ–°é–‹å§‹)</button>
    </div>

    <div id="result-modal"></div>

    <div id="admin-panel">
        <button onclick="adminSettle()">å¼·åˆ¶å¼•çˆ†</button>
        <button onclick="adminReset()">æ ¼å¼åŒ–</button>
    </div>
</div>

<script>
    // âš ï¸ æ›¿æ›æˆä½ çš„ Ngrok ç¶²å€
    const API_BASE = "https://untruckled-dalilah-twitchily.ngrok-free.dev"; 
    
    const headers = { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' };
    
    if (new URLSearchParams(window.location.search).get('admin') === 'true') {
        document.getElementById('admin-panel').style.display = 'block';
    }
    
    let currentUser = "";
    let myTotalBet = 0;
    let myTickets = 0;
    let myTotalWon = 0;
    let dropTimer = null;
    let pollingInterval = null;
    let isGrabbing = false;
    let isAutoOn = false;
    let currentDropSpeed = 400;

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    async function submitBet() {
        const user = document.getElementById('username').value.trim();
        const amount = parseInt(document.getElementById('bet-amount').value, 10);
        const msgEl = document.getElementById('bet-msg');

        if (!user || isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "åƒæ•¸éŒ¯èª¤ï¼"; return; }

        document.getElementById('btn-bet').disabled = true; msgEl.innerText = "é€£ç·šä¸­...";
        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: user, amount: amount }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            currentUser = user; myTickets = data.tickets; myTotalBet = data.total_bet; myTotalWon = 0;
            document.getElementById('display-name').innerText = currentUser;
            updateWaitScreenInfo(); switchScreen('screen-wait'); startPolling(); 
        } catch (err) { msgEl.innerText = err.message; document.getElementById('btn-bet').disabled = false; }
    }

    async function submitRaise() {
        const amount = parseInt(document.getElementById('raise-amount').value, 10);
        const msgEl = document.getElementById('raise-msg');
        if (isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "ç„¡æ•ˆçš„è³‡é‡‘"; return; }

        document.getElementById('btn-raise').disabled = true; msgEl.innerText = "è¿½åŠ ä¸­...";
        try {
            const res = await fetch(`${API_BASE}/bet`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser, amount: amount }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets; myTotalBet = data.total_bet; updateWaitScreenInfo();
            document.getElementById('raise-amount').value = ''; msgEl.innerText = "âœ… ç®—åŠ›å·²å‡ç´š";
            setTimeout(() => { msgEl.innerText = ""; }, 2000);
        } catch (err) { msgEl.innerText = err.message; } finally { document.getElementById('btn-raise').disabled = false; }
    }

    function updateWaitScreenInfo() {
        document.getElementById('display-current-bet').innerText = myTotalBet;
        document.getElementById('display-current-tickets').innerText = myTickets;
        updateStatusBar();
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                document.getElementById('wait-status').innerText = `ç¸½è³‡é‡‘æ± : ${data.total_pool} | ç‹€æ…‹: ${data.status}`;
                if (data.status === "GRABBING") { clearInterval(pollingInterval); startGame(); }
            } catch (err) { console.error(err); }
        }, 1000);
    }

    function startGame() { switchScreen('screen-grab'); scheduleNextDrop(); }

    function scheduleNextDrop() {
        if (myTickets <= 0) return;
        createEnvelope();
        dropTimer = setTimeout(scheduleNextDrop, currentDropSpeed);
    }

    // --- æ§åˆ¶é¢æ¿é‚è¼¯ ---
    function toggleAutoBot() {
        isAutoOn = !isAutoOn;
        const btn = document.getElementById('btn-auto');
        const area = document.getElementById('game-area');
        
        if(isAutoOn) {
            btn.classList.add('active-toggle');
            btn.innerText = "âš¡ é—œé–‰å¤–æ›";
            area.classList.add('overdrive');
            currentDropSpeed = 80; // åŠ é€Ÿæ‰è½
            showResultText("OVERDRIVE");
        } else {
            btn.classList.remove('active-toggle');
            btn.innerText = "âš¡ è‡ªå‹•ä»£æ¶";
            area.classList.remove('overdrive');
            currentDropSpeed = 400;
        }
    }

    // ğŸ¤– å¤–æ›è¿´åœˆ (æ¯ 50ms ç‹‚é»)
    setInterval(() => {
        if (isAutoOn && myTickets > 0 && !isGrabbing) {
            const targets = document.querySelectorAll('.envelope:not(.grabbed)');
            if (targets.length > 0) targets[0].click();
        }
    }, 50);

    // --- â­ï¸ æš´åŠ›è·³é (Skip) é‚è¼¯ ---
    async function skipGrabbing() {
        if (myTickets <= 0 || isGrabbing) return;
        if (!confirm("è­¦å‘Šï¼šå³å°‡åœ¨èƒŒæ™¯ç¬é–“æ¶ˆè€—æ‰€æœ‰ç®—åŠ›ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ")) return;

        // é—œé–‰ç•«é¢èˆ‡ç‰¹æ•ˆ
        clearTimeout(dropTimer);
        isAutoOn = false;
        document.getElementById('btn-auto').classList.remove('active-toggle');
        document.getElementById('game-area').classList.remove('overdrive');
        document.getElementById('game-area').innerHTML = '<h2 style="color: #fbc02d; margin-top: 80px; text-shadow: 0 0 10px #fbc02d;">â­ï¸ æš´åŠ›ç ´è§£ä¸­...<br><span style="font-size:14px; color:#aaa;">(ä¾æ“šå‰©é¤˜æ¬¡æ•¸ï¼Œå¯èƒ½éœ€æ•¸ç§’é˜)</span></h2>';

        isGrabbing = true;

        try {
            // åˆ©ç”¨ while è¿´åœˆå¿«é€Ÿæ‰“ APIï¼Œç›´åˆ°æ¬¡æ•¸æ­¸é›¶æˆ–æ± å­ç©ºäº†
            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ await æ˜¯ç‚ºäº†é¿å… Ngrok æŠŠä½µç™¼å¤ªé«˜çš„è«‹æ±‚ç•¶ä½œ DDoS æ“‹æ‰
            while (myTickets > 0) {
                const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);

                myTickets = data.tickets_left;
                myTotalWon = data.total_won_so_far;
                updateStatusBar();
            }
        } catch (err) {
            if(err.message !== "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") console.error(err);
        } finally {
            isGrabbing = false;
            if (myTickets <= 0) endGame();
        }
    }

    function createEnvelope() {
        const area = document.getElementById('game-area');
        const env = document.createElement('div');
        env.className = 'envelope';
        env.innerText = 'ğŸ§§';
        env.style.left = (Math.random() * (area.clientWidth - 45)) + 'px';
        const duration = isAutoOn ? (Math.random() * 0.8 + 0.8) : (Math.random() * 1.5 + 1.2);
        env.style.animationDuration = duration + 's';
        env.onclick = () => grabEnvelope(env);
        area.appendChild(env);
        setTimeout(() => { if(env.parentElement) env.remove(); }, duration * 1000);
    }

    function triggerScreenShake() {
        const app = document.getElementById('app');
        app.classList.remove('shake'); void app.offsetWidth; app.classList.add('shake');
    }

    function spawnFloatingNumber(amount, x, y) {
        const area = document.getElementById('game-area');
        const floatText = document.createElement('div');
        floatText.className = 'floating-amount'; floatText.innerText = `+${amount}`;
        floatText.style.left = x; floatText.style.top = y;
        area.appendChild(floatText); setTimeout(() => floatText.remove(), 600);
    }

    async function grabEnvelope(envElement) {
        if (myTickets <= 0 || isGrabbing || envElement.classList.contains('grabbed')) return;
        envElement.classList.add('grabbed'); envElement.classList.add('grabbed-effect');
        
        const rect = envElement.getBoundingClientRect();
        const areaRect = document.getElementById('game-area').getBoundingClientRect();
        const relativeX = (rect.left - areaRect.left + 22) + 'px'; 
        const relativeY = (rect.top - areaRect.top) + 'px';

        isGrabbing = true;
        try {
            const res = await fetch(`${API_BASE}/grab`, { method: 'POST', headers: headers, body: JSON.stringify({ user_id: currentUser }) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets_left; myTotalWon = data.total_won_so_far; updateStatusBar();
            
            triggerScreenShake(); spawnFloatingNumber(data.won_amount, relativeX, relativeY);
            if (myTickets <= 0) endGame();
        } catch (err) {
            if(err.message === "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") endGame();
        } finally { isGrabbing = false; }
    }

    function endGame() {
        clearTimeout(dropTimer);
        document.getElementById('game-area').innerHTML = '<h2 style="color: #00e5ff; margin-top: 80px; text-shadow: 0 0 10px #00e5ff;">é€£ç·šä¸­æ–·<br><br><span style="font-size:16px;">ç­‰å¾…ç³»çµ±æœ€çµ‚çµç®—...</span></h2>';
        
        const waitInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, { headers: headers });
                const data = await res.json();
                if (data.status === "FINISHED") { clearInterval(waitInterval); fetchLeaderboard(); }
            } catch (err) { console.error(err); }
        }, 1500);
    }

    async function fetchLeaderboard() {
        switchScreen('screen-leaderboard');
        try {
            const res = await fetch(`${API_BASE}/leaderboard`, { headers: headers });
            const data = await res.json();
            const tbody = document.getElementById('leaderboard-body'); tbody.innerHTML = '';
            
            data.leaderboard.forEach((player, index) => {
                const isMe = player.user === currentUser ? 'background-color: rgba(255,215,0,0.15); font-weight: bold;' : '';
                const color = player.profit >= 0 ? 'color: #ff5252;' : 'color: #00ffaa;';
                
                const tr = document.createElement('tr'); tr.style = isMe;
                tr.innerHTML = `<td>${index + 1}</td><td>${player.user}</td><td>${player.bet}</td><td>${player.won}</td><td style="${color}">${player.profit > 0 ? '+'+player.profit : player.profit}</td><td style="${color}">${player.roi}%</td>`;
                tbody.appendChild(tr);
            });
        } catch (err) { alert("ç„¡æ³•å–å¾—æ’è¡Œæ¦œ: " + err.message); }
    }

    function updateStatusBar() { document.getElementById('display-tickets').innerText = myTickets; document.getElementById('display-won').innerText = myTotalWon; }
    function showResultText(text) { const modal = document.getElementById('result-modal'); modal.innerText = text; modal.style.display = 'block'; setTimeout(() => modal.style.display = 'none', 600); }

    async function adminSettle() {
        const secret = prompt("ç³»çµ±æˆæ¬Šç¢¼ï¼š"); if (!secret) return;
        try { const res = await fetch(`${API_BASE}/admin/settle`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) }); if (!res.ok) throw new Error((await res.json()).detail); } catch (err) { alert(err.message); }
    }
    async function adminReset() {
        const secret = prompt("ç³»çµ±æˆæ¬Šç¢¼ï¼š"); if (!secret || !confirm("ç¢ºå®šæ ¼å¼åŒ–ï¼Ÿ")) return;
        try { const res = await fetch(`${API_BASE}/admin/reset`, { method: 'POST', headers: headers, body: JSON.stringify({ secret: secret }) }); if (!res.ok) throw new Error((await res.json()).detail); window.location.reload(); } catch (err) { alert(err.message); }
    }
</script>
</body>
</html>