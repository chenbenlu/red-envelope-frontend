<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶ç´…åŒ…ç³»çµ±</title>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #app { width: 100%; max-width: 400px; height: 100vh; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; text-align: center; display: flex; flex-direction: column; }
        .screen { display: none; flex: 1; padding: 20px; flex-direction: column; justify-content: center; }
        .active { display: flex; }
        h1 { color: #d32f2f; }
        input { padding: 10px; font-size: 16px; width: 80%; margin-bottom: 10px; text-align: center; }
        button { padding: 10px 20px; font-size: 18px; background-color: #d32f2f; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px;}
        button:disabled { background-color: #ccc; }
        
        #game-area { position: relative; flex: 1; background-color: #ffebee; overflow: hidden; border-top: 2px solid #d32f2f; border-bottom: 2px solid #d32f2f; }
        .status-bar { padding: 10px; background: #fff; font-weight: bold; }
        
        .envelope { position: absolute; width: 50px; height: 70px; background-color: #d32f2f; color: gold; border-radius: 5px; display: flex; justify-content: center; align-items: center; font-weight: bold; cursor: pointer; user-select: none; animation: fall linear forwards; }
        @keyframes fall { from { top: -80px; } to { top: 100%; } }

        #result-modal { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 100; }
        
        #admin-panel { position: absolute; bottom: 10px; right: 10px; font-size: 12px; }
        #admin-panel button { background: #333; padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-bet" class="screen active">
        <h1>ç´…åŒ…å¤§æŒ‘æˆ°</h1>
        <input type="text" id="username" placeholder="è¼¸å…¥ç©å®¶åç¨± (ä¾‹å¦‚: ç´…åŒ…å°å·)">
        <input type="number" id="bet-amount" placeholder="è¼¸å…¥æŠ•æ³¨é‡‘é¡ (100çš„å€æ•¸)" step="100" min="100">
        <button id="btn-bet" onclick="submitBet()">ç¢ºèªæŠ•æ³¨</button>
        <p id="bet-msg" style="color: red;"></p>
    </div>

    <div id="screen-wait" class="screen">
        <h1>ç­‰å¾…é–‹å±€...</h1>
        <p>ä¼ºæœå™¨æ­£åœ¨çµç®—ç¸½çé‡‘æ± </p>
        <p id="wait-status">ç›®å‰ç‹€æ…‹: è¼ªè©¢ä¸­...</p>
    </div>

    <div id="screen-grab" class="screen" style="padding: 0;">
        <div class="status-bar">
            ç©å®¶: <span id="display-name"></span> | å‰©é¤˜æ¬¡æ•¸: <span id="display-tickets">0</span> | å·²ç²é‡‘é¡: <span id="display-won">0</span>
        </div>
        <div id="game-area"></div>
    </div>

    <div id="result-modal"></div>

    <div id="admin-panel">
        <button onclick="adminSettle()">ç®¡ç†å“¡: å¼·åˆ¶çµç®—</button>
    </div>
</div>

<script>
    // é€™è£¡æ›æˆäº†ä½ å°ˆå±¬çš„ ngrok ç¶²å€
    const API_BASE = "https://untruckled-dalilah-twitchily.ngrok-free.dev"; 
    
    let currentUser = "";
    let myTickets = 0;
    let myTotalWon = 0;
    let gameInterval = null;
    let pollingInterval = null;
    let isGrabbing = false;

    function switchScreen(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    async function submitBet() {
        const user = document.getElementById('username').value.trim();
        const amount = parseInt(document.getElementById('bet-amount').value, 10);
        const msgEl = document.getElementById('bet-msg');

        if (!user) { msgEl.innerText = "è«‹è¼¸å…¥ç©å®¶åç¨±ï¼"; return; }
        if (isNaN(amount) || amount <= 0 || amount % 100 !== 0) { msgEl.innerText = "è«‹è¼¸å…¥ 100 çš„å€æ•¸ï¼"; return; }

        document.getElementById('btn-bet').disabled = true;
        msgEl.innerText = "é€£ç·šä¸­...";

        try {
            const res = await fetch(`${API_BASE}/bet`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true' // ç¹é ngrok è­¦å‘Š
                },
                body: JSON.stringify({ user_id: user, amount: amount })
            });
            const data = await res.json();

            if (!res.ok) throw new Error(data.detail || "æŠ•æ³¨å¤±æ•—");

            currentUser = user;
            myTickets = data.tickets;
            myTotalWon = 0;
            document.getElementById('display-name').innerText = currentUser;
            updateStatusBar();
            
            switchScreen('screen-wait');
            startPolling(); 

        } catch (err) {
            msgEl.innerText = err.message;
            document.getElementById('btn-bet').disabled = false;
        }
    }

    function startPolling() {
        pollingInterval = setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE}/status`, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true' // ç¹é ngrok è­¦å‘Š
                    }
                });
                const data = await res.json();
                document.getElementById('wait-status').innerText = `ç¸½çæ± : ${data.total_pool} å…ƒ | ç‹€æ…‹: ${data.status}`;
                
                if (data.status === "GRABBING") {
                    clearInterval(pollingInterval);
                    startGame();
                }
            } catch (err) {
                console.error("è¼ªè©¢å¤±æ•—:", err);
            }
        }, 1000);
    }

    async function grabEnvelope(envElement) {
        if (myTickets <= 0 || isGrabbing) return;

        envElement.style.pointerEvents = 'none';
        envElement.style.display = 'none';
        isGrabbing = true;

        try {
            const res = await fetch(`${API_BASE}/grab`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true' // ç¹é ngrok è­¦å‘Š
                },
                body: JSON.stringify({ user_id: currentUser })
            });
            const data = await res.json();

            if (!res.ok) throw new Error(data.detail);

            myTickets = data.tickets_left;
            myTotalWon = data.total_won_so_far;
            updateStatusBar();
            showResultText(`æ¶åˆ° ${data.won_amount} å…ƒï¼`);

            if (myTickets <= 0) endGame();

        } catch (err) {
            alert("æ¶å¥ªå¤±æ•—: " + err.message);
            if(err.message === "ç´…åŒ…å·²ç¶“è¢«æ¶å…‰äº†") endGame();
        } finally {
            isGrabbing = false;
        }
    }

    async function adminSettle() {
        try {
            const res = await fetch(`${API_BASE}/admin/settle`, { 
                method: 'POST',
                headers: {
                    'ngrok-skip-browser-warning': 'true' // ç¹é ngrok è­¦å‘Š
                }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail);
            alert("å·²å¼·åˆ¶çµç®—ï¼Œé–‹å±€ï¼");
        } catch (err) {
            alert("çµç®—å¤±æ•—: " + err.message);
        }
    }

    function startGame() {
        switchScreen('screen-grab');
        gameInterval = setInterval(createEnvelope, 500);
    }

    function createEnvelope() {
        if (myTickets <= 0) { clearInterval(gameInterval); return; }

        const area = document.getElementById('game-area');
        const env = document.createElement('div');
        env.className = 'envelope';
        env.innerText = 'ğŸ§§';
        
        const leftPos = Math.random() * (area.clientWidth - 50);
        env.style.left = leftPos + 'px';
        const duration = Math.random() * 1.5 + 1.5;
        env.style.animationDuration = duration + 's';

        env.onclick = () => grabEnvelope(env);
        area.appendChild(env);

        setTimeout(() => { if(env.parentElement) env.remove(); }, duration * 1000);
    }

    function updateStatusBar() {
        document.getElementById('display-tickets').innerText = myTickets;
        document.getElementById('display-won').innerText = myTotalWon;
    }

    function showResultText(text) {
        const modal = document.getElementById('result-modal');
        modal.innerText = text;
        modal.style.display = 'block';
        setTimeout(() => modal.style.display = 'none', 1000);
    }

    function endGame() {
        clearInterval(gameInterval);
        setTimeout(() => {
            alert(`éŠæˆ²çµæŸï¼ä½ ç¸½å…±ç²å¾—äº† ${myTotalWon} å…ƒ`);
            window.location.reload(); 
        }, 1000);
    }
</script>
</body>
</html>